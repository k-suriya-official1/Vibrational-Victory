<!DOCTYPE html>
<html>
<head>
  <title>To-Do List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-top: 0;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    input[type="text"] {
      flex-grow: 1;
    }
    input[type="number"] {
      width: 80px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .done-btn {
      background-color: #3498db;
    }
    .delete-btn {
      background-color: #e74c3c;
    }
    .priority-high {
      background-color: rgba(231, 76, 60, 0.1);
    }
    .priority-medium {
      background-color: rgba(241, 196, 15, 0.1);
    }
    .completed {
      text-decoration: line-through;
      color: #7f8c8d;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #555;
    }
    .error-message {
      color: #e74c3c;
      text-align: center;
      padding: 10px;
      background-color: rgba(231, 76, 60, 0.1);
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <h1>To-Do List</h1>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
    
    <div id="errorMsg" class="error-message"></div>
    
    <form id="taskForm">
      <input type="text" id="task" placeholder="Enter task" required>
      <input type="date" id="dueDate" required>
      <input type="time" id="dueTime" required>
      <input type="number" id="priority" placeholder="Priority (1-999)" min="1" max="999" required>
      <button type="submit">Add Task</button>
    </form>
    
    <div id="loading" class="loading">Loading tasks...</div>
    
    <table id="tasksTable">
      <thead>
        <tr>
          <th>Task</th>
          <th>Created Date</th>
          <th>Due Date</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Tasks will be populated here -->
      </tbody>
    </table>
  </div>

  <script>
    // Replace with your Google Apps Script Web App URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbxAD2Dz8p-3McqcWV_D_9xhlrZ-_y2bLOJscIHS6fO01jucU9C_W268ZDn-YkL_NhLtag/exec'; // You need to replace this with your deployed script URL
    
    // Check if user is logged in
    if (sessionStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'index.html';
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', function() {
      sessionStorage.removeItem('isLoggedIn');
      window.location.href = 'index.html';
    });

    // Show error message
    function showError(message) {
      const errorElement = document.getElementById('errorMsg');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      setTimeout(() => {
        errorElement.style.display = 'none';
      }, 5000);
    }

    // Add task function
    document.getElementById('taskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const task = document.getElementById('task').value;
      const dueDate = document.getElementById('dueDate').value;
      const dueTime = document.getElementById('dueTime').value;
      const priority = document.getElementById('priority').value;
      
      // Show loading
      document.getElementById('loading').style.display = 'block';
      
      // Send request to Google Apps Script
      fetch(`${API_URL}?action=add&task=${encodeURIComponent(task)}&dueDate=${encodeURIComponent(dueDate)}&dueTime=${encodeURIComponent(dueTime)}&priority=${encodeURIComponent(priority)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.text();
        })
        .then(data => {
          // Reset form and refresh task list
          this.reset();
          loadTasks();
        })
        .catch(error => {
          showError('Failed to add task: ' + error.message);
          document.getElementById('loading').style.display = 'none';
        });
    });

    // Load tasks from Google Sheet
    function loadTasks() {
      document.getElementById('loading').style.display = 'block';
      
      fetch(`${API_URL}?action=list`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(tasks => {
          displayTasks(tasks);
          document.getElementById('loading').style.display = 'none';
        })
        .catch(error => {
          showError('Failed to load tasks: ' + error.message);
          document.getElementById('loading').style.display = 'none';
        });
    }

    // Display tasks in the table
    function displayTasks(tasks) {
      const tbody = document.querySelector('#tasksTable tbody');
      tbody.innerHTML = '';
      
      // Sort tasks by priority (high to low) and status (incomplete first)
      tasks.sort((a, b) => {
        if (a.Done !== b.Done) {
          return a.Done === true ? 1 : -1;
        }
        return b.Priority - a.Priority;
      });
      
      tasks.forEach(task => {
        const row = document.createElement('tr');
        
        // Add priority-based styling
        if (task.Priority >= 80) {
          row.classList.add('priority-high');
        } else if (task.Priority >= 30) {
          row.classList.add('priority-medium');
        }
        
        if (task.Done === true) {
          row.classList.add('completed');
        }
        
        // Task name cell
        const taskCell = document.createElement('td');
        taskCell.textContent = task.Task;
        row.appendChild(taskCell);
        
        // Created date cell
        const createdDateCell = document.createElement('td');
        createdDateCell.textContent = `${task['Created Date']} ${task['Created Time']}`;
        row.appendChild(createdDateCell);
        
        // Due date cell
        const dueDateTimeCell = document.createElement('td');
        dueDateTimeCell.textContent = `${task['Due Date']} ${task['Due Time']}`;
        row.appendChild(dueDateTimeCell);
        
        // Priority cell
        const priorityCell = document.createElement('td');
        priorityCell.textContent = task.Priority;
        row.appendChild(priorityCell);
        
        // Status cell
        const statusCell = document.createElement('td');
        statusCell.textContent = task.Done === true ? 'Completed' : 'Pending';
        row.appendChild(statusCell);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        actionsCell.className = 'action-buttons';
        
        // Toggle completion button
        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = task.Done === true ? 'Undo' : 'Complete';
        toggleBtn.className = 'done-btn';
        toggleBtn.addEventListener('click', () => {
          document.getElementById('loading').style.display = 'block';
          const newStatus = task.Done === true ? 'false' : 'true';
          fetch(`${API_URL}?action=update&task=${encodeURIComponent(task.Task)}&done=${newStatus}`)
            .then(response => {
              if (!response.ok) throw new Error('Failed to update task');
              loadTasks();
            })
            .catch(error => {
              showError('Error updating task: ' + error.message);
              document.getElementById('loading').style.display = 'none';
            });
        });
        actionsCell.appendChild(toggleBtn);
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'delete-btn';
        deleteBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to delete this task?')) {
            document.getElementById('loading').style.display = 'block';
            fetch(`${API_URL}?action=delete&task=${encodeURIComponent(task.Task)}`)
              .then(response => {
                if (!response.ok) throw new Error('Failed to delete task');
                loadTasks();
              })
              .catch(error => {
                showError('Error deleting task: ' + error.message);
                document.getElementById('loading').style.display = 'none';
              });
          }
        });
        actionsCell.appendChild(deleteBtn);
        
        row.appendChild(actionsCell);
        tbody.appendChild(row);
      });
    }

    // Initial load of tasks
    loadTasks();
  </script>
</body>
</html>